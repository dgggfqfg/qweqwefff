function [Vi, V, Vindex] = Vulnerability_wu(Mat, isinv, E)

% [Vi, V] = Vulnerability(Mat,E)
% ...calculates vulnerability Vi of a node i as the
% drop in network performance when node i and its connections are removed

% Mat= Binary inputmatrix , size NxN, N=number of channels
% E= Eglob= Global efficiency: how efficiently information can be exchanged
%    over network
% V= Vulnerability, size 1xN, N= number of channels

N = size(Mat,1);

if isinv
    Mat = Mat.^(-1); ind = isinf(Mat); Mat(ind)=0;    
end

H = waitbar(0,'Vulnerability computation ...');
Vi = zeros(N,1);
for node = 1: N
    disp(node);
    waitbar(node/N,H);
    aux_Mat = Mat;
    aux_Mat(node, :) = [];
    aux_Mat(:, node) = []; 
    aux_D = distance_wu(aux_Mat);
    Ei = Efficiency(aux_Mat, aux_D);
    Vi(node) = (E - Ei) / E;
end

if nargout > 1
    [V,Vindex] = max(Vi);
end
close(H);

